<div class="mb-6 relative">
    <div class="flex space-x-4 overflow-x-auto no-scrollbar pb-2 px-4 md:px-0">
        
        <div class="flex flex-col items-center space-y-1 min-w-[70px] cursor-pointer group">
            <div class="h-[70px] w-[70px] rounded-full p-[2px] border-2 border-dashed border-slate-300 group-hover:border-indigo-500 transition relative">
                <div class="h-full w-full rounded-full bg-slate-100 flex items-center justify-center overflow-hidden">
                    {% if user.profile.avatar %}
                        <img src="{{ user.profile.avatar.url }}" class="h-full w-full object-cover opacity-50">
                    {% else %}
                        <i class="fas fa-plus text-slate-400"></i>
                    {% endif %}
                </div>
                <div class="absolute bottom-0 right-0 bg-indigo-500 text-white rounded-full w-6 h-6 flex items-center justify-center border-2 border-white text-xs">
                    <i class="fas fa-plus"></i>
                </div>
            </div>
            <span class="text-xs text-slate-500 font-medium truncate w-full text-center">Seu story</span>
        </div>

        {% for story in stories %}
        <div class="flex flex-col items-center space-y-1 min-w-[70px] cursor-pointer group">
            <div class="h-[70px] w-[70px] rounded-full p-[2px] bg-gradient-to-tr from-yellow-400 via-rose-500 to-purple-600">
                <div class="h-full w-full rounded-full bg-white p-[2px]">
                    <img src="{{ story.author.profile.avatar.url|default:'https://i.pravatar.cc/150' }}" class="h-full w-full rounded-full object-cover transition group-hover:scale-105">
                </div>
            </div>
            <span class="text-xs text-slate-600 font-medium truncate w-full text-center">{{ story.author.username }}</span>
        </div>
        {% endfor %}
    </div>
</div>

<div class="px-4 md:px-0 mb-8" x-data="postCreator()">
    <div class="bg-white/80 backdrop-blur-xl border border-white/60 rounded-3xl shadow-sm p-4 relative overflow-hidden transition-all duration-300"
         :class="{'ring-2 ring-indigo-500/20 shadow-lg': isFocused}">
        
        <form hx-post="{% url 'create_bird' %}" 
              hx-target="#feed-list" 
              hx-swap="afterbegin"
              hx-encoding="multipart/form-data"
              @htmx:after-request="resetForm()"
              class="relative z-10">
            
            {% csrf_token %}

            <div class="flex gap-4">
                <div class="shrink-0">
                    <div class="h-11 w-11 rounded-full bg-indigo-50 overflow-hidden">
                        {% if user.profile.avatar %}
                            <img src="{{ user.profile.avatar.url }}" class="h-full w-full object-cover">
                        {% else %}
                            <img src="https://ui-avatars.com/api/?name={{ user.username }}" class="h-full w-full object-cover">
                        {% endif %}
                    </div>
                </div>

                <div class="flex-1">
                    <textarea name="content" 
                              x-model="content"
                              @focus="isFocused = true" 
                              @blur="isFocused = false"
                              rows="2" 
                              class="w-full bg-transparent border-none p-2 text-lg text-slate-700 placeholder-slate-400 focus:ring-0 resize-none"
                              placeholder="No que você está pensando, {{ user.first_name }}?"></textarea>

                    <div x-show="mediaPreview" class="mt-3 relative rounded-xl overflow-hidden bg-slate-100 max-h-[300px]" style="display: none;">
                        <button type="button" @click="clearMedia()" class="absolute top-2 right-2 bg-black/50 text-white rounded-full p-1.5 hover:bg-black/70 z-20">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                        
                        <template x-if="mediaType === 'image'">
                            <img :src="mediaPreview" class="w-full h-full object-cover">
                        </template>

                        <template x-if="mediaType === 'video'">
                            <video :src="mediaPreview" controls class="w-full h-full object-contain bg-black"></video>
                        </template>
                    </div>

                    <div class="flex items-center justify-between mt-4 pt-3 border-t border-slate-100">
                        <div class="flex items-center gap-2">
                            <label class="p-2 rounded-full hover:bg-indigo-50 text-indigo-500 cursor-pointer transition relative group">
                                <i class="far fa-image text-lg"></i>
                                <input type="file" name="image" accept="image/*" class="hidden" @change="handleFile($event, 'image')">
                                <span class="absolute -top-8 left-1/2 -translate-x-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition">Foto</span>
                            </label>

                            <label class="p-2 rounded-full hover:bg-rose-50 text-rose-500 cursor-pointer transition relative group">
                                <i class="fas fa-video text-lg"></i>
                                <input type="file" name="video" accept="video/*" class="hidden" @change="handleFile($event, 'video')">
                                <span class="absolute -top-8 left-1/2 -translate-x-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition">Vídeo</span>
                            </label>
                            
                            <button type="button" class="p-2 rounded-full hover:bg-yellow-50 text-yellow-500 transition hidden md:block">
                                <i class="far fa-smile text-lg"></i>
                            </button>
                        </div>

                        <button type="submit" 
                                :disabled="!content && !mediaPreview"
                                :class="{'opacity-50 cursor-not-allowed': !content && !mediaPreview}"
                                class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-full font-bold shadow-lg shadow-indigo-200 transition-all transform active:scale-95 flex items-center gap-2">
                            <span>Publicar</span>
                            <i class="fas fa-paper-plane text-xs"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="htmx-indicator absolute inset-0 bg-white/50 backdrop-blur-sm flex items-center justify-center z-20 rounded-3xl">
                <i class="fas fa-circle-notch fa-spin text-indigo-600 text-2xl"></i>
            </div>
        </form>
    </div>
</div>

<div id="feed-list" class="px-4 md:px-0 pb-20 space-y-6">
    {% for bird in birds %}
        {% include 'components/bird_item.html' %}
    {% empty %}
        <div class="text-center py-20 opacity-60">
            <div class="bg-slate-100 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-feather-alt text-4xl text-slate-300"></i>
            </div>
            <h3 class="text-lg font-bold text-slate-700">Tudo quieto por aqui</h3>
            <p class="text-slate-500">Seja o primeiro a publicar algo!</p>
        </div>
    {% endfor %}
</div>

<script>
    function postCreator() {
        return {
            content: '',
            isFocused: false,
            mediaPreview: null,
            mediaType: null,

            handleFile(event, type) {
                const file = event.target.files[0];
                if (!file) return;

                this.mediaType = type;
                this.mediaPreview = URL.createObjectURL(file);
            },

            clearMedia() {
                this.mediaPreview = null;
                this.mediaType = null;
                // Limpa os inputs de arquivo
                document.querySelectorAll('input[type="file"]').forEach(input => input.value = '');
            },

            resetForm() {
                this.content = '';
                this.clearMedia();
                this.isFocused = false;
            }
        }
    }
</script>